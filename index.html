<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gentle Â· Pay-per-Ask</title>
<style>
  :root{
    --bg:#0c1118; --panel:#121925; --bubble:#0e1621; --me:#1b2a3a; --text:#e8f0ff; --muted:#9db0c8;
    --border:#1e2b3d; --accent:#65e1a3; --accent2:#8cc7ff;
  }
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a0f14,#0e1621 55%,#0c1118);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"PingFang HK","Noto Sans TC","Microsoft JhengHei",sans-serif;}
  .wrap{max-width:880px;margin:auto;padding:14px}
  .taskbar{display:flex;gap:8px;overflow:auto;padding:6px}
  .chip{flex:0 0 auto;border:1px solid var(--border);background:#0d1520;color:#d9e6ff;border-radius:999px;
    padding:8px 12px;cursor:pointer;white-space:nowrap}
  .chip.active{background:linear-gradient(90deg,#2fe0a2,#7ae0ff);color:#06222b;border-color:transparent}
  .card{background:rgba(18,25,37,.72);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:16px}
  .chat{display:flex;flex-direction:column;gap:10px;height:62vh;min-height:360px;max-height:68vh;overflow:auto;padding:14px}
  .row{display:flex;gap:10px;align-items:flex-end;padding:10px}
  .in{display:flex;gap:8px;align-items:center;border-top:1px solid var(--border);padding:10px}
  textarea{flex:1;border:1px solid var(--border);background:#0b121b;color:var(--text);border-radius:12px;padding:10px 12px;
    min-height:56px;resize:vertical}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:#182334;color:#dbe8ff}
  .btn.primary{background:linear-gradient(90deg,#2fe0a2,#7ae0ff);color:#06222b;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .bubble{max-width:84%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);white-space:pre-wrap}
  .bot{align-self:flex-start}.bot .bubble{background:var(--bubble)}
  .me{align-self:flex-end}.me .bubble{background:var(--me)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .filebox{display:flex;gap:8px;flex-wrap:wrap}
  .filechip{border:1px dashed var(--border);background:#0c1521;color:#cfe0ff;border-radius:10px;padding:6px 8px;font-size:12px}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .pro{display:none;padding:10px;border-top:1px solid var(--border)}
  select,input[type="file"]{border:1px solid var(--border);background:#0b121b;color:var(--text);border-radius:10px;padding:8px 10px}
  .hint{font-size:12px;color:var(--muted)}
  @media (max-width:720px){ .chat{height:56vh;max-height:60vh} }
</style>
</head>
<body>
<div class="wrap">

  <!-- ä»»å‹™æŒ‰éˆ• -->
  <div class="card" style="margin-bottom:10px">
    <div class="taskbar" id="taskbar">
      <button class="chip active" data-task="ask">ç™¼å•</button>
      <button class="chip" data-task="letter">å¯«ä¿¡</button>
      <button class="chip" data-task="vision">åˆ†æåœ–ç‰‡</button>
      <button class="chip" data-task="translate">ç¿»è­¯</button>
      <button class="chip" data-task="imggen">ç”Ÿæˆåœ–ç‰‡æç¤ºè©</button>
    </div>
    <div class="bar">
      <div class="hint">é¸ä¸€å€‹ä»»å‹™ â†’ æ‰“å­—æˆ–ä¸Šè¼‰ â†’ æŒ‰é€å‡ºã€‚å””ä½¿è­˜åƒæ•¸ï¼Œå°ˆæ¥­æ¨¡å¼å…ˆæ€æ¨¡å‹ã€‚</div>
      <button id="togglePro" class="btn">å°ˆæ¥­æ¨¡å¼ï¼šé—œ</button>
    </div>
    <!-- å°ˆæ¥­æ¨¡å¼ -->
    <div id="pro" class="pro">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <label>ä½ çš„ Email
          <input id="email" placeholder="you@example.com" style="min-width:220px">
        </label>
        <label>æ¨¡å‹
          <select id="model">
            <option value="openai/gpt-5-chat">openai/gpt-5-chatï¼ˆé€šç”¨/åœ–åƒï¼‰</option>
            <option value="anthropic/claude-3.7-sonnet">anthropic/claude-3.7-sonnetï¼ˆç©©å®šï¼‰</option>
            <option value="google/gemini-2.5-flash">google/gemini-2.5-flashï¼ˆå¿«æ·ï¼‰</option>
            <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:freeï¼ˆå…è²»ï¼‰</option>
            <option value="deepseek/deepseek-r1">deepseek/deepseek-r1ï¼ˆæ¨ç†/è¼ƒè²´ï¼‰</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- èŠå¤©æ¡† -->
  <div class="card chat" id="chat">
    <!-- æ­¡è¿è¨Šæ¯ -->
    <div class="bot">
      <div class="bubble">ğŸ‘‹ æ­¡è¿ï¼ä¸Šé¢æ€ä»»å‹™ï¼Œå–ºä¸‹é¢è¼¸å…¥æˆ–ä¸Šè¼‰æª”æ¡ˆï¼Œæˆ‘æœƒå¹«ä½ è™•ç†ã€‚</div>
      <div class="meta">æç¤ºï¼šEnter é€å‡ºï¼ŒShift+Enter æ›è¡Œ</div>
    </div>
  </div>

  <!-- è¼¸å…¥åˆ— -->
  <div class="card in">
    <input id="file" type="file" multiple>
    <textarea id="input" placeholder="è¼¸å…¥è¨Šæ¯â€¦ï¼ˆæ”¯æ´è²¼åœ–/ä¸Šè¼‰æª”æ¡ˆï¼‰"></textarea>
    <button id="send" class="btn primary">é€å‡º</button>
  </div>

  <!-- æª”æ¡ˆé è¦½ -->
  <div class="filebox" id="filebox" style="padding:6px 2px"></div>
</div>

<script>
const EXEC_URL = "https://script.google.com/macros/s/AKfycbzOKVyOurzY2sPadLE_OxwKZVbyKPNbbo7gfygWzLVy7O-KyCiff34yRsBXIlD4ZV4/exec";

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const fileInput = document.getElementById('file');
const fileBox = document.getElementById('filebox');
const sendBtn = document.getElementById('send');
const proBtn = document.getElementById('togglePro');
const proPanel = document.getElementById('pro');
const modelSel = document.getElementById('model');
const emailInput = document.getElementById('email');

let currentTask = 'ask';
let history = []; // {role, content} ä¾›é€å»å¾Œç«¯
let pendingFiles = []; // {file, b64, mime, name}

// ä»»å‹™é è¨­å­—çœ¼ï¼ˆç°¡çŸ­ï¼Œç”¨å®¶å‹å–„ï¼‰
const PRESETS = {
  ask: "è«‹ç”¨ç²µèªå›ç­”ä»¥ä¸‹å•é¡Œï¼Œå…ˆè¬›é‡é»ï¼Œå†ä»¥ç°¡å–®è¦é»è§£é‡‹ï¼š",
  letter: "å¹«æˆ‘ç”¨é¦™æ¸¯æ›¸é¢èªä»£å¯«ä¸€å°é›»éƒµï¼šåŒ…å«ä¸»æ—¨ã€ç¦®è²Œé–‹å ´ã€ä¸»é«”åˆ†æ®µã€æ¸…æ™°çµå°¾ã€‚",
  vision: "åˆ†ææˆ‘ä¸Šè¼‰çš„åœ–ç‰‡ï¼š1) æè¿°é‡é» 2) å¦‚æœ‰æ–‡å­—è«‹ OCR 3) çµ¦å‡ºå»ºè­°æˆ–é¢¨éšª 4) ä»¥ç²µèªå›è¦†ã€‚",
  translate: "æŠŠä»¥ä¸‹å…§å®¹è­¯æˆç²µèªï¼ˆé¦™æ¸¯ç”¨å­—ï¼‰ï¼›å¦‚é™„åœ–è«‹å…ˆ OCR å†ç¿»è­¯ã€‚",
  imggen: "å¹«æˆ‘å¯«è‹±æ–‡ç”Ÿæˆåœ–ç‰‡çš„ promptï¼š1) ä¸€å¥ä¸»æç¤º 2) 4â€“6 å€‹ä¿®é£¾åƒæ•¸ï¼ˆé¡é ­/å…‰ç·š/é¢¨æ ¼ç­‰ï¼‰3) ä¸€å¥è² é¢æç¤ºã€‚"
};

// ä»»å‹™æŒ‰éˆ•äº‹ä»¶
document.querySelectorAll('.chip').forEach(chip=>{
  chip.onclick = ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentTask = chip.dataset.task;
    // å»ºè­°æ¨¡å‹ï¼ˆåƒ…ç•¶å°ˆæ¥­æ¨¡å¼æœªé–‹å•Ÿæ™‚æé†’ï¼‰
    if (currentTask === 'vision' && !proPanel.style.display) modelSel.value = 'openai/gpt-5-chat';
    if (currentTask === 'imggen' && !proPanel.style.display) modelSel.value = 'openai/gpt-5-chat';
    if (!input.value.trim()) input.value = PRESETS[currentTask];
    input.focus();
  };
});

// å°ˆæ¥­æ¨¡å¼åˆ‡æ›
proBtn.onclick = ()=>{
  const on = proPanel.style.display === 'block';
  proPanel.style.display = on ? 'none' : 'block';
  proBtn.textContent = `å°ˆæ¥­æ¨¡å¼ï¼š${on ? 'é—œ' : 'é–‹'}`;
};

// è²¼åœ–å¿«é€Ÿä¸Šè¼‰
window.addEventListener('paste', async (e)=>{
  if (!e.clipboardData) return;
  for (const item of e.clipboardData.items) {
    if (item.kind === 'file') {
      const file = item.getAsFile();
      await addFile(file);
    }
  }
});

// é¸æª”
fileInput.onchange = async ()=>{
  for (const f of fileInput.files) await addFile(f);
  fileInput.value = "";
};

// é€å‡ºå¿«æ·éµ
input.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// é€å‡º
sendBtn.onclick = async ()=>{
  const text = input.value.trim();
  const email = (emailInput?.value || "").trim();

  if (!text && pendingFiles.length===0){
    input.placeholder = "è«‹å…ˆè¼¸å…¥æˆ–ä¸Šè¼‰æª”æ¡ˆ";
    return;
  }
  if (proPanel.style.display === 'block' && !email){
    alert("å°ˆæ¥­æ¨¡å¼å·²é–‹ï¼Œè«‹è¼¸å…¥ Email ç”¨ä½œè¨˜éŒ„ã€‚");
    return;
  }

  // å‰ç«¯é¡¯ç¤ºï¼šç”¨å®¶è¨Šæ¯
  pushBubble('me', text || '(åªæœ‰é™„ä»¶)');
  if (pendingFiles.length) {
    const names = pendingFiles.map(p=>p.name).join("ã€");
    pushBubble('me', `ğŸ“ å·²ä¸Šè¼‰ï¼š${names}`, true);
  }

  // æ§‹é€  messagesï¼ˆç°¡åŒ–ï¼šæŠŠä»»å‹™ preset + ä½ è¼¸å…¥å˜…å…§å®¹åˆä½µåšä¸€å€‹ user messageï¼‰
  const base = PRESETS[currentTask] ? PRESETS[currentTask] + "\n\n" : "";
  const messages = [...history, { role:"user", content: base + (text || "") }];

  // æ§‹é€  attachments
  const attachments = pendingFiles.map(p=>({
    filename: p.name, mimeType: p.mime, dataBase64: p.b64
  }));

  // æ§‹é€  payload
  const payload = {
    email: proPanel.style.display === 'block' ? email : "",          // å°ˆæ¥­æ¨¡å¼å…ˆè¨˜ email
    model: modelSel.value,                                           // å¯åœ¨å°ˆæ¥­æ¨¡å¼æ€æ¨¡å‹ï¼›å¹³æ™‚ç”¨é è¨­å€¼
    messages,
    attachments
  };

  lock(true);
  const typingId = pushBubble('bot', 'æ­£åœ¨æ€è€ƒâ€¦', true);

  try{
    const r = await fetch(EXEC_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json; charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const json = await r.json();
    // ç§»é™¤ã€Œæ­£åœ¨æ€è€ƒâ€¦ã€
    removeBubble(typingId);

    if (!json || json.success === false){
      pushBubble('bot', `âŒ å¤±æ•—ï¼ˆä¸Šæ¸¸${json?.upstream_status||''}ï¼‰ï¼š\n${json?.upstream_body || json?.error || 'æœªçŸ¥éŒ¯èª¤'}`);
      lock(false);
      return;
    }

    // é¡¯ç¤º AI å›è¦† + meta
    pushBubble('bot', json.reply || '(ç„¡å…§å®¹)');
    if (json.usage || json.cost_hkd !== undefined){
      pushMeta(`æ¨¡å‹ï¼š${json.model} Â· tokens=${json.usage?.total_tokens ?? '-'} Â· HKD$${json.cost_hkd ?? '-'}`);
    }

    // æ›´æ–°å‰ç«¯å°è©±æ­·å²
    history = [...messages, { role:"assistant", content: json.reply || "" }];

  }catch(err){
    removeBubble(typingId);
    pushBubble('bot', 'âŒ é€£ç·šå¤±æ•—ï¼š' + String(err));
  }finally{
    lock(false);
    input.value = "";
    pendingFiles = [];
    fileBox.innerHTML = "";
  }
};

// å·¥å…·ï¼šåŠ å…¥/ç§»é™¤æ°£æ³¡
let _id = 0;
function pushBubble(who, text, isMeta=false){
  const id = 'b'+(++_id);
  const item = document.createElement('div');
  item.className = who;
  const b = document.createElement('div');
  b.className = 'bubble';
  b.textContent = text;
  item.appendChild(b);
  if (!isMeta){
    const m = document.createElement('div');
    m.className = 'meta';
    m.textContent = who==='me'?'ä½ ':'AI';
    item.appendChild(m);
  }
  item.dataset.id = id;
  chat.appendChild(item);
  chat.scrollTop = chat.scrollHeight;
  return id;
}
function removeBubble(id){
  const el = chat.querySelector(`[data-id="${id}"]`);
  if (el) el.remove();
}
function pushMeta(text){
  const m = document.createElement('div');
  m.className = 'meta';
  m.textContent = text;
  chat.appendChild(m);
  chat.scrollTop = chat.scrollHeight;
}

// æª”æ¡ˆé è¦½
async function addFile(file){
  if (!file) return;
  const b64 = await fileToBase64(file);
  pendingFiles.push({file, b64, mime:file.type||"application/octet-stream", name:file.name});
  const chip = document.createElement('div');
  chip.className = 'filechip';
  chip.textContent = file.name + (file.type.startsWith('image/') ? ' ğŸ–¼ï¸' : '');
  fileBox.appendChild(chip);
}
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(String(fr.result).split(",")[1]);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function lock(on){
  sendBtn.disabled = on;
  input.disabled = on;
  fileInput.disabled = on;
}
</script>
</body>
</html>
