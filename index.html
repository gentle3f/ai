<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>貼地 AI – Pay-per-Ask</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#1f2a37; --sub:#6b7280;
    --primary:#2563eb; --primary-weak:#e5edff; --danger:#ef4444;
    --ring: rgba(37,99,235,.35); --shadow:0 6px 24px rgba(0,0,0,.07);
    --radius:16px; --footer-h: clamp(78px, 20vh, 170px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"PingFang HK","PingFang TC","Noto Sans TC","Heiti TC",Arial,sans-serif}
  .wrap{min-height:100%;padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom))}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,#ffffffcc);
    backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #eef2f7}
  .bar{max-width:1100px;margin:auto;padding:14px 16px 10px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chip{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;cursor:pointer;user-select:none}
  .chip:hover{border-color:#d1d5db}
  .chip.primary{background:var(--primary-weak);border-color:#caddff;color:#143a9c}
  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .muted{color:var(--sub)}
  .field{display:flex;gap:10px;align-items:center;margin-top:10px}
  .field input{flex:1;min-width:220px;padding:12px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;outline:none}
  .field input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.danger{background:#fff;color:var(--danger);border-color:#ffd9da}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  main{max-width:1100px;margin:10px auto 0;padding:0 16px}
  .chat{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;min-height:48vh}
  .bubble{max-width:92%;padding:12px 14px;border-radius:14px;margin:8px 0;line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
  .me{background:#e8f0ff;border:1px solid #cfe0ff;margin-left:auto}
  .ai{background:#f5f7fb;border:1px solid #e6eaf2}
  .meta{font-size:12px;color:var(--sub);margin:4px 2px 0}
  .composer{position:fixed;left:0;right:0;bottom:0;z-index:15;background:#fff;border-top:1px solid #e8edf4;
    padding:10px 12px calc(10px + env(safe-area-inset-bottom))}
  .composer-inner{max-width:1100px;margin:auto;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:end}
  .upload-label{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border:1px dashed #cfd7e6;border-radius:12px;background:#fafbff;cursor:pointer}
  .upload-label input{display:none}
  textarea{width:100%;resize:none;max-height:10lh;min-height:3lh;padding:12px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;outline:none}
  textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
  .send{min-width:84px;padding:12px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;cursor:pointer}
  .hint{max-width:1100px;margin:6px auto 10px;padding:0 16px;color:var(--sub);font-size:12px}
  .spacer{height:calc(var(--footer-h) + env(safe-area-inset-bottom))}
  @media (max-width:720px){.bubble{max-width:100%}}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="bar">
      <div class="row">
        <div class="chip primary" data-task="ask">發問</div>
        <div class="chip" data-task="letter">寫信</div>
        <div class="chip" data-task="vision">分析圖片</div>
        <div class="chip" data-task="translate">翻譯</div>
        <div class="chip" data-task="imgprompt">生成圖片提示詞</div>

        <div class="right">
          <button class="btn" id="btnLang">粵語</button>
          <button class="btn danger" id="btnClear">清除對話</button>
          <span class="muted">專業模式：</span><button class="btn" id="btnPro">關</button>
        </div>
      </div>
      <div class="field">
        <label class="muted">電郵（必填）：</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email">
      </div>
    </div>
  </header>

  <main>
    <div id="chat" class="chat">
      <div class="bubble ai">👋 歡迎！上面揀任務，下面輸入或上載檔案，我會一步步引導你。</div>
      <div class="meta">AI</div>
    </div>
    <div class="spacer" aria-hidden="true"></div>
  </main>

  <div class="composer" role="region" aria-label="輸入區">
    <div class="composer-inner">
      <label class="upload-label">📎 上載<input id="file" type="file" multiple accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt"></label>
      <textarea id="input" placeholder="輸入訊息…（支援貼圖／上載檔案）" rows="3" enterkeyhint="done"></textarea>
      <button class="send" id="btnSend">送出</button>
    </div>
  </div>
  <div class="hint">提示：電腦 Enter 送出、Shift+Enter 換行；手機 Enter 會換行，請按「送出」。</div>
</div>

const $=s=>document.querySelector(s);
const chat=$('#chat'), input=$('#input'), emailEl=$('#email'), fileEl=$('#file');
const btnSend=$('#btnSend'), btnClear=$('#btnClear'), btnPro=$('#btnPro'), btnLang=$('#btnLang');
const IS_MOBILE = matchMedia("(pointer:coarse)").matches || /Android|iPhone|iPad/i.test(navigator.userAgent);

let LANG=(localStorage.getItem('lang')||'zh');
let PRO=JSON.parse(localStorage.getItem('pro')||'false');

/* ✅ 單一來源：API 變數，並確保一定有值 */
let API = new URLSearchParams(location.search).get('api') || localStorage.getItem('api') || '';
if (!API) {
  const u = prompt('請貼上 Apps Script 的 /exec URL：');
  if (u) { API = u.trim(); localStorage.setItem('api', API); }
}
if (API) localStorage.setItem('api', API);

emailEl.value=localStorage.getItem('email')||'';

/* ===== 任務預設 ===== */
const PRESETS={ zh:{
  ask:"請用廣東話回答以下問題，先講重點，再以簡單要點解釋：",
  letter:"幫我寫一封電郵：\n收件人：\n主題：\n口吻：禮貌專業\n內容要點：\n",
  vision:"請幫我分析呢張相，列出你見到嘅重點，然後俾出建議：",
  translate:"幫我把以下文字翻譯成粵語口語：\n",
  imgprompt:"幫我寫一段清晰的圖片生成提示詞（stable diffusion / gpt-image / flux），主題："
}};

/* ===== 綁定 ===== */
document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>pickTask(c.dataset.task)));
btnClear.addEventListener('click',()=>{ chat.innerHTML='<div class="bubble ai">🧹 已開新對話。</div><div class="meta">AI</div>'; input.value=''; });
btnPro.addEventListener('click',()=>{ PRO=!PRO; localStorage.setItem('pro',JSON.stringify(PRO)); btnPro.textContent=PRO?'開':'關';
  pushAI(PRO?'🔧 專業模式已開：輸入 /model 以指定模型（如 openai/gpt-5-chat）。':'已關閉專業模式。系統會自動幫你揀模型。');});
btnLang.addEventListener('click',()=>{ LANG=(LANG==='zh'?'en':'zh'); localStorage.setItem('lang',LANG); btnLang.textContent=LANG==='zh'?'粵語':'EN'; });

input.addEventListener('focus',()=>setTimeout(()=>input.scrollIntoView({block:'nearest'}),180));
input.addEventListener('keydown',(e)=>{ if(e.key!=='Enter')return; if(IS_MOBILE)return; if(e.shiftKey)return; e.preventDefault(); sendNow(); });
btnSend.addEventListener('click',sendNow);
fileEl.addEventListener('change',()=>{ /* show selection if needed */ });

input.addEventListener('input',()=>{ input.style.height='auto'; const lh=parseFloat(getComputedStyle(input).lineHeight)||20; input.style.height=Math.min(input.scrollHeight, lh*6)+'px'; });

/* email 改變 → 清除已驗證 */
emailEl.addEventListener('input',()=>{ localStorage.removeItem('verifiedEmail'); setSendEnabled(false); });

btnPro.textContent=PRO?'開':'關'; btnLang.textContent=LANG==='zh'?'粵語':'EN';

/* ===== 啟動時自動驗證（如 email 已填 & API 已設） ===== */
(async function boot(){
  if (!API) { setSendEnabled(false); pushAI('⚠️ API 未設定，請重新載入並按提示貼上 /exec URL。'); return; }
  const saved=localStorage.getItem('verifiedEmail');
  if (saved && saved.toLowerCase()===(emailEl.value||'').trim().toLowerCase()) {
    setSendEnabled(true);
  } else if ((emailEl.value||'').trim()) {
    const ok = await verifyEmailServer((emailEl.value||'').trim());
    if (ok) { localStorage.setItem('verifiedEmail', (emailEl.value||'').trim()); setSendEnabled(true); }
    else { setSendEnabled(false); }
  } else {
    setSendEnabled(false);
  }
})();

/* ===== 功能 ===== */
function pickTask(task){
  input.value=""; input.placeholder=PRESETS.zh[task]||"輸入訊息…";
  pushAI('✅ 已選擇任務：'+({ask:'發問',letter:'寫信',vision:'分析圖片',translate:'翻譯',imgprompt:'生成圖片提示詞'}[task]||task)+'。請按提示輸入，或上載檔案。');
  input.focus();
}

function getEmailRequired(){
  const v=(emailEl.value||'').trim();
  if(!v){ emailEl.focus(); emailEl.reportValidity?.(); return null; }
  localStorage.setItem('email',v); return v;
}
function setSendEnabled(on){ btnSend.disabled=!on; }

/* ✅ 統一用 API 變數；加強容錯 + console 記錄  */
async function verifyEmailServer(email){
  if (!API) return false;
  try{
    const r=await fetch(API+'?verify='+encodeURIComponent(email), { cache:'no-store' });
    const ct=(r.headers.get('content-type')||'').toLowerCase();
    if (ct.includes('application/json')) {
      const j=await r.json();
      console.log('[verify] json', j);
      return !!j.ok;
    } else {
      const txt=(await r.text()).trim();
      console.log('[verify] text', txt);
      if (/\"ok\"\s*:\s*true/.test(txt)) return true;
      if (/^\s*\{\s*ok\s*:\s*true\s*\}\s*$/i.test(txt)) return true;
      if (/^true$/i.test(txt)) return true;
      return false;
    }
  }catch(e){
    console.warn('[verify] error', e);
    return false;
  }
}

async function ensureEmailVerified(){
  const email=(emailEl.value||'').trim(); if(!email){ emailEl.focus(); return false; }
  const cached=localStorage.getItem('verifiedEmail');
  if(cached && cached.toLowerCase()===email.toLowerCase()){ setSendEnabled(true); return true; }
  setSendEnabled(false);
  const ok=await verifyEmailServer(email);
  if(ok){ localStorage.setItem('verifiedEmail',email); setSendEnabled(true); return true; }
  pushAI('⚠️ 你嘅電郵未被授權使用，請聯絡負責人加入白名單。'); emailEl.focus(); return false;
}

async function sendNow(){
  const email=getEmailRequired(); if(!email) return;
  if(!(await ensureEmailVerified())) return;

  const text=(input.value||'').trim();
  const files=[...(fileEl.files||[])];
  if(!text && files.length===0){ input.placeholder="請輸入文字或上載檔案…"; input.focus(); return; }

  input.value=''; pushMe(text||'(只有附件)');

  const attachments=[];
  for(const f of files){ const b64=await fileToBase64(f); attachments.push({filename:f.name,mimeType:f.type||guessMime(f.name),dataBase64:b64}); }
  fileEl.value='';

  let model='openai/gpt-5-chat';
  if(attachments.some(a=>a.mimeType.startsWith('image/'))) model='openai/gpt-5-vision-preview';
  if(PRO && text.startsWith('/model ')) model=text.split(/\s+/)[1]||model;

  const messages=[{role:'user',content:text}];
  const payload={email,model,messages,attachments};

  try{
    const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const ct=r.headers.get('content-type')||'';
    const data=ct.includes('application/json')? await r.json() : {success:false,error:(await r.text()).slice(0,400)};
    if(!data.success){ pushAI('❌ 連線失敗：'+(data.error||data.upstream_body||'未知錯誤')); return; }
    pushAI(data.reply||'(無內容)');
    if(data.usage){ pushMeta(`${data.model} · tokens=${data.usage.total_tokens||0} · HKD$${(data.cost_hkd||0)}`); }
  }catch(err){
    pushAI('❌ 連線失敗：'+String(err));
  }
}

/* ===== UI helpers ===== */
function pushMe(t){ pushBubble('me',t); }
function pushAI(t){ pushBubble('ai',t); }
function pushMeta(t){ const el=document.createElement('div'); el.className='meta'; el.textContent=t; chat.appendChild(el); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }
function pushBubble(who,t){ const b=document.createElement('div'); b.className='bubble '+(who==='me'?'me':'ai'); b.textContent=t; chat.appendChild(b); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }

function fileToBase64(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res((r.result||'').split(',')[1]||''); r.onerror=rej; r.readAsDataURL(file); });
}
function guessMime(name=''){
  const n=name.toLowerCase();
  if(n.endsWith('.png'))return'image/png';
  if(n.endsWith('.jpg')||n.endsWith('.jpeg'))return'image/jpeg';
  if(n.endsWith('.webp'))return'image/webp';
  if(n.endsWith('.pdf'))return'application/pdf';
  if(n.endsWith('.doc'))return'application/msword';
  if(n.endsWith('.docx'))return'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
  if(n.endsWith('.ppt'))return'application/vnd.ms-powerpoint';
  if(n.endsWith('.pptx'))return'application/vnd.openxmlformats-officedocument.presentationml.presentation';
  if(n.endsWith('.xls'))return'application/vnd.ms-excel';
  if(n.endsWith('.xlsx'))return'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
  if(n.endsWith('.txt'))return'text/plain';
  return'application/octet-stream';
}
</body>
</html>


