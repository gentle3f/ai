<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>è²¼åœ° AI â€“ Pay-per-Ask</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#1f2a37; --sub:#6b7280;
    --primary:#2563eb; --primary-weak:#e5edff; --danger:#ef4444; --ok:#16a34a;
    --ring:rgba(37,99,235,.35); --shadow:0 6px 24px rgba(0,0,0,.07);
    --radius:16px; --footer-h:clamp(88px, 22vh, 180px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"PingFang HK","PingFang TC","Noto Sans TC","Heiti TC",Arial,sans-serif}
  .wrap{min-height:100%;padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom))}
  header{position:sticky;top:0;z-index:10;background:#fff;backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid #eef2f7}
  .bar{max-width:1100px;margin:auto;padding:14px 16px 10px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chip{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;cursor:pointer;user-select:none}
  .chip:hover{border-color:#d1d5db}
  .chip.primary{background:var(--primary-weak);border-color:#caddff;color:#143a9c}
  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .muted{color:var(--sub)}
  .field{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .field input{flex:1;min-width:220px;padding:12px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;outline:none}
  .field input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.danger{background:#fff;color:var(--danger);border-color:#ffd9da}
  .btn.ok{background:#eaf7ef;color:#0f5d2f;border-color:#cfeedd}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .badge.ok{color:#0f5d2f;background:#eaf7ef;border-color:#cfeedd}
  .badge.err{color:#a70d17;background:#fff0f1;border-color:#ffd9da}
  main{max-width:1100px;margin:10px auto 0;padding:0 16px}
  .chat{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;min-height:48vh}
  .bubble{max-width:92%;padding:12px 14px;border-radius:14px;margin:8px 0;line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
  .me{background:#e8f0ff;border:1px solid #cfe0ff;margin-left:auto}
  .ai{background:#f5f7fb;border:1px solid #e6eaf2}
  .meta{font-size:12px;color:var(--sub);margin:4px 2px 0}
  .composer{position:fixed;left:0;right:0;bottom:0;z-index:15;background:#fff;border-top:1px solid #e8edf4;
    padding:10px 12px calc(10px + env(safe-area-inset-bottom))}
  .composer-inner{max-width:1100px;margin:auto;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:end}
  .upload-label{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border:1px dashed #cfd7e6;border-radius:12px;background:#fafbff;cursor:pointer}
  .upload-label input{display:none}
  #files{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 0 0}
  .filepill{font-size:12px;padding:6px 8px;border:1px solid #dbe3f2;border-radius:999px;background:#f7f9ff}
  textarea{width:100%;resize:none;max-height:10lh;min-height:3lh;padding:12px 14px;border-radius:12px;border:1px solid #dce3ef;background:#fff;outline:none}
  textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
  .send{min-width:84px;padding:12px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;cursor:pointer}
  .hint{max-width:1100px;margin:6px auto 10px;padding:0 16px;color:var(--sub);font-size:12px}
  .spacer{height:calc(var(--footer-h) + env(safe-area-inset-bottom))}
  @media (max-width:720px){.bubble{max-width:100%}}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="bar">
      <div class="row">
        <div class="chip primary" data-task="ask" id="chip-ask">ç™¼å•</div>
        <div class="chip" data-task="letter" id="chip-letter">å¯«ä¿¡</div>
        <div class="chip" data-task="vision" id="chip-vision">åˆ†æåœ–ç‰‡</div>
        <div class="chip" data-task="translate" id="chip-translate">ç¿»è­¯</div>
        <div class="chip" data-task="imgprompt" id="chip-imgprompt">ç”Ÿæˆåœ–ç‰‡æç¤ºè©</div>

        <div class="right">
          <button class="btn" id="btnLang">ç²µèª</button>
          <button class="btn danger" id="btnClear">æ¸…é™¤å°è©±</button>
          <span class="muted" id="lblPro">å°ˆæ¥­æ¨¡å¼ï¼š</span><button class="btn" id="btnPro">é—œ</button>
        </div>
      </div>

      <div class="field">
        <label class="muted" id="lblEmail">é›»éƒµï¼ˆå¿…å¡«ï¼‰ï¼š</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email">
        <button class="btn" id="btnApi">è¨­å®š API</button>
        <button class="btn" id="btnVerify">é©—è­‰</button>
        <span class="badge" id="verBadge">æœªé©—è­‰</span>
      </div>
    </div>
  </header>

  <main>
    <div id="chat" class="chat">
      <div class="bubble ai" id="welcome">ğŸ‘‹ æ­¡è¿ï¼ä¸Šé¢æ€ä»»å‹™ï¼Œä¸‹é¢è¼¸å…¥æˆ–ä¸Šè¼‰æª”æ¡ˆï¼Œæˆ‘æœƒä¸€æ­¥æ­¥å¼•å°ä½ ã€‚</div>
      <div class="meta">AI</div>
    </div>
    <div class="spacer" aria-hidden="true"></div>
  </main>

  <div class="composer" role="region" aria-label="è¼¸å…¥å€">
    <div class="composer-inner">
      <div>
        <label class="upload-label" id="lblUpload">ğŸ“ ä¸Šè¼‰<input id="file" type="file" multiple accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt"></label>
        <div id="files" aria-live="polite"></div>
      </div>
      <textarea id="input" placeholder="è¼¸å…¥è¨Šæ¯â€¦" rows="3" enterkeyhint="done"></textarea>
      <button class="send" id="btnSend" disabled>é€å‡º</button>
    </div>
  </div>
  <div class="hint" id="hint">æç¤ºï¼šé›»è…¦ Enter é€å‡ºã€Shift+Enter æ›è¡Œï¼›æ‰‹æ©Ÿ Enter æœƒæ›è¡Œï¼Œè«‹æŒ‰ã€Œé€å‡ºã€ã€‚</div>
</div>

<script>
/* ===== åŸºæœ¬ç‹€æ…‹ ===== */
const $=s=>document.querySelector(s);
const chat=$('#chat'), input=$('#input'), emailEl=$('#email'), fileEl=$('#file'), filesBox=$('#files');
const btnSend=$('#btnSend'), btnClear=$('#btnClear'), btnPro=$('#btnPro'), btnLang=$('#btnLang'), btnApi=$('#btnApi'), btnVerify=$('#btnVerify');
const verBadge=$('#verBadge');
const IS_MOBILE = matchMedia("(pointer:coarse)").matches || /Android|iPhone|iPad/i.test(navigator.userAgent);

let LANG=(localStorage.getItem('lang')||'zh');
let PRO=JSON.parse(localStorage.getItem('pro')||'false');

/* å–®ä¸€ API ä¾†æº */
let API=new URLSearchParams(location.search).get('api')||localStorage.getItem('api')||'';
if(!API){
  const u=prompt('è«‹è²¼ä¸Š Apps Script çš„ /exec URLï¼š');
  if(u){ API=u.trim(); localStorage.setItem('api',API); }
}
if(API) localStorage.setItem('api',API);
console.log('[API]', API);

emailEl.value=localStorage.getItem('email')||'';

/* ===== æ–‡æ¡ˆ ===== */
const I18N={ zh:{
  chips:{ask:'ç™¼å•',letter:'å¯«ä¿¡',vision:'åˆ†æåœ–ç‰‡',translate:'ç¿»è­¯',imgprompt:'ç”Ÿæˆåœ–ç‰‡æç¤ºè©'},
  welcome:'ğŸ‘‹ æ­¡è¿ï¼ä¸Šé¢æ€ä»»å‹™ï¼Œä¸‹é¢è¼¸å…¥æˆ–ä¸Šè¼‰æª”æ¡ˆï¼Œæˆ‘æœƒä¸€æ­¥æ­¥å¼•å°ä½ ã€‚',
  email:'é›»éƒµï¼ˆå¿…å¡«ï¼‰ï¼š', pro:'å°ˆæ¥­æ¨¡å¼ï¼š', upload:'ğŸ“ ä¸Šè¼‰', hint:'æç¤ºï¼šé›»è…¦ Enter é€å‡ºã€Shift+Enter æ›è¡Œï¼›æ‰‹æ©Ÿ Enter æœƒæ›è¡Œï¼Œè«‹æŒ‰ã€Œé€å‡ºã€ã€‚',
  presets:{
    ask:'è«‹ç”¨å»£æ±è©±å›ç­”ä»¥ä¸‹å•é¡Œï¼Œå…ˆè¬›é‡é»ï¼Œå†ä»¥ç°¡å–®è¦é»è§£é‡‹ï¼š',
    letter:'å¹«æˆ‘å¯«ä¸€å°é›»éƒµï¼š\næ”¶ä»¶äººï¼š\nä¸»é¡Œï¼š\nå£å»ï¼šç¦®è²Œå°ˆæ¥­\nå…§å®¹è¦é»ï¼š\n',
    vision:'è«‹å¹«æˆ‘åˆ†æå‘¢å¼µç›¸ï¼Œåˆ—å‡ºä½ è¦‹åˆ°å˜…é‡é»ï¼Œç„¶å¾Œä¿¾å‡ºå»ºè­°ï¼š',
    translate:'å¹«æˆ‘æŠŠä»¥ä¸‹æ–‡å­—ç¿»è­¯æˆç²µèªå£èªï¼š\n',
    imgprompt:'å¹«æˆ‘å¯«ä¸€æ®µæ¸…æ™°çš„åœ–ç‰‡ç”Ÿæˆæç¤ºè©ï¼ˆstable diffusion / gpt-image / fluxï¼‰ï¼Œä¸»é¡Œï¼š'
  }
}, en:{
  chips:{ask:'Ask',letter:'Write letter',vision:'Analyze image',translate:'Translate',imgprompt:'Image prompt'},
  welcome:'ğŸ‘‹ Welcome! Pick a task above, then type or upload below. Iâ€™ll guide you step by step.',
  email:'Email (required):', pro:'Pro mode:', upload:'ğŸ“ Upload', hint:'Tip: Enter to send (desktop), Shift+Enter for newline. On mobile press â€œSendâ€.',
  presets:{
    ask:'Answer the question. Start with key points, then explain in simple bullets:',
    letter:'Write an email:\nTo:\nSubject:\nTone: Polite & professional\nKey points:\n',
    vision:'Analyze this image. List key observations then give suggestions:',
    translate:'Translate into natural Cantonese:',
    imgprompt:'Write a clear image generation prompt (stable diffusion / gpt-image / flux). Topic:'
  }
}};
function t(k){ return k.split('.').reduce((o,kk)=>o&&o[kk], I18N[LANG]||I18N.zh); }

/* ===== ç¶å®š ===== */
document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>pickTask(c.dataset.task)));
btnClear.addEventListener('click',()=>{ chat.innerHTML=`<div class="bubble ai">${t('welcome')}</div><div class="meta">AI</div>`; input.value=''; filesBox.innerHTML=''; fileEl.value=''; });
btnPro.addEventListener('click',()=>{ PRO=!PRO; localStorage.setItem('pro',JSON.stringify(PRO)); btnPro.textContent=PRO?'é–‹':'é—œ';
  pushAI(PRO?'ğŸ”§ å·²é–‹å•Ÿå°ˆæ¥­æ¨¡å¼ï¼šè¼¸å…¥ /model ä»¥æŒ‡å®šæ¨¡å‹ï¼ˆå¦‚ openai/gpt-5-chatï¼‰ã€‚':'å·²é—œé–‰å°ˆæ¥­æ¨¡å¼ã€‚ç³»çµ±æœƒè‡ªå‹•æ€æ¨¡å‹ã€‚');});
btnLang.addEventListener('click',()=>{ LANG=(LANG==='zh'?'en':'zh'); localStorage.setItem('lang',LANG); applyLang(); });

btnApi.addEventListener('click', ()=>{
  const cur=localStorage.getItem('api')||'';
  const u=prompt('è²¼ä¸Š Apps Script çš„ /exec URLï¼š', cur);
  if(u && u.trim()){ localStorage.setItem('api',u.trim()); location.reload(); }
});
btnVerify.addEventListener('click', manualVerify);

input.addEventListener('focus',()=>setTimeout(()=>input.scrollIntoView({block:'nearest'}),180));
input.addEventListener('keydown',(e)=>{ if(e.key!=='Enter')return; if(IS_MOBILE)return; if(e.shiftKey)return; e.preventDefault(); sendNow(); });
btnSend.addEventListener('click',sendNow);

fileEl.addEventListener('change',()=>{ filesBox.innerHTML=''; [...fileEl.files].forEach(f=>{ const s=document.createElement('span'); s.className='filepill'; s.textContent=f.name; filesBox.appendChild(s); }); });

input.addEventListener('input',()=>{ input.style.height='auto'; const lh=parseFloat(getComputedStyle(input).lineHeight)||20; input.style.height=Math.min(input.scrollHeight, lh*6)+'px'; });
emailEl.addEventListener('input',()=>{ localStorage.removeItem('verifiedEmail'); setVerified(false); setSendEnabled(false); });

/* ===== åˆå§‹ UI ===== */
applyLang(); btnPro.textContent=PRO?'é–‹':'é—œ';

/* ===== é–‹é è‡ªå‹• verify ===== */
(async function boot(){
  if(!API){ setSendEnabled(false); setVerified(false,'API æœªè¨­å®š'); pushAI('âš ï¸ API æœªè¨­å®šï¼Œè«‹æŒ‰ã€Œè¨­å®š APIã€ã€‚'); return; }
  const saved=localStorage.getItem('verifiedEmail');
  if(saved && emailEl.value && saved.toLowerCase()===emailEl.value.trim().toLowerCase()){
    setVerified(true,'æœ¬æ©Ÿå·²é©—è­‰'); setSendEnabled(true);
  }else if(emailEl.value){
    const ok=await verifyEmailServer(emailEl.value.trim());
    setVerified(ok, ok?'å·²é©—è­‰':'æœªé©—è­‰'); setSendEnabled(ok);
  }else{ setVerified(false); setSendEnabled(false); }
})();

/* ===== èªè¨€æ‡‰ç”¨ ===== */
function applyLang(){
  $('#chip-ask').textContent=t('chips.ask');
  $('#chip-letter').textContent=t('chips.letter');
  $('#chip-vision').textContent=t('chips.vision');
  $('#chip-translate').textContent=t('chips.translate');
  $('#chip-imgprompt').textContent=t('chips.imgprompt');
  $('#welcome').textContent=t('welcome');
  $('#lblEmail').textContent=t('email');
  $('#lblPro').textContent=t('pro');
  $('#lblUpload').textContent=t('upload');
  $('#hint').textContent=t('hint');
  btnLang.textContent = (LANG==='zh' ? 'ç²µèª' : 'EN');
  if(!input.value) input.placeholder = (LANG==='zh'?'è¼¸å…¥è¨Šæ¯â€¦':'Type a messageâ€¦');
}

/* ===== ä»»å‹™ ===== */
function pickTask(task){
  input.value=""; input.placeholder=t('presets.'+task)|| (LANG==='zh'?'è¼¸å…¥è¨Šæ¯â€¦':'Type a messageâ€¦');
  pushAI('âœ… '+(LANG==='zh'?'å·²é¸æ“‡ä»»å‹™ï¼š':'Selected task: ')+($('#chip-'+task).textContent)+'ã€‚'+(LANG==='zh'?'è«‹æŒ‰æç¤ºè¼¸å…¥ï¼Œæˆ–ä¸Šè¼‰æª”æ¡ˆã€‚':'Follow the hint or upload files.'));
  input.focus();
}

/* ===== é©—è­‰æ§åˆ¶ ===== */
function setVerified(ok, txt){
  verBadge.classList.toggle('ok', !!ok);
  verBadge.classList.toggle('err', !ok);
  verBadge.textContent = ok ? (txt||'å·²é©—è­‰') : (txt||'æœªé©—è­‰');
}
function setSendEnabled(on){ btnSend.disabled=!on; }

async function manualVerify(){
  const email = (emailEl.value||'').trim(); if(!email){ emailEl.focus(); return; }
  setVerified(false,'é©—è­‰ä¸­â€¦'); setSendEnabled(false);
  const ok = await verifyEmailServer(email);
  setVerified(ok, ok?'å·²é©—è­‰':'æœªé©—è­‰');
  if(ok){ localStorage.setItem('verifiedEmail', email); setSendEnabled(true); }
}

async function verifyEmailServer(email){
  if(!API) return false;
  try{
    const url = API + (API.includes('?') ? '&' : '?') + 'verify=' + encodeURIComponent(email);
    const r=await fetch(url,{cache:'no-store'});
    const ct=(r.headers.get('content-type')||'').toLowerCase();
    if(ct.includes('application/json')){ const j=await r.json(); console.log('[verify json]', j); return !!j.ok; }
    const txt=(await r.text()).trim(); console.log('[verify text]', txt);
    if(/\"ok\"\s*:\s*true/.test(txt)) return true;
    if(/^\s*\{\s*ok\s*:\s*true\s*\}\s*$/i.test(txt)) return true;
    if(/^true$/i.test(txt)) return true;
    return false;
  }catch(e){ console.warn('[verify err]', e); return false; }
}

function getEmailRequired(){
  const v=(emailEl.value||'').trim();
  if(!v){ emailEl.focus(); emailEl.reportValidity?.(); return null; }
  localStorage.setItem('email',v); return v;
}

/* ===== é€å‡º ===== */
async function sendNow(){
  const email=getEmailRequired(); if(!email) return;

  // è‡ªå‹•é©—è­‰ï¼ˆå°±ç®—æœªå…ˆæŒ‰ã€Œé©—è­‰ã€ï¼‰
  let verified = localStorage.getItem('verifiedEmail');
  if(!(verified && verified.toLowerCase()===email.toLowerCase())){
    setVerified(false,'é©—è­‰ä¸­â€¦'); setSendEnabled(false);
    const ok = await verifyEmailServer(email);
    setVerified(ok, ok?'å·²é©—è­‰':'æœªé©—è­‰'); if(!ok){ pushAI('âš ï¸ ä½ å˜…é›»éƒµæœªè¢«æˆæ¬Šä½¿ç”¨ï¼Œè«‹è¯çµ¡è² è²¬äººåŠ å…¥ç™½åå–®ã€‚'); return; }
    localStorage.setItem('verifiedEmail', email); setSendEnabled(true);
  }

  const text=(input.value||'').trim();
  const files=[...(fileEl.files||[])];
  if(!text && files.length===0){ input.placeholder=(LANG==='zh'?'è«‹è¼¸å…¥æ–‡å­—æˆ–ä¸Šè¼‰æª”æ¡ˆâ€¦':'Enter text or upload filesâ€¦'); input.focus(); return; }

  input.value=''; pushMe(text||'(åªæœ‰é™„ä»¶)');
  const attachments=[];
  for(const f of files){ const b64=await fileToBase64(f); attachments.push({filename:f.name,mimeType:f.type||guessMime(f.name),dataBase64:b64}); }
  fileEl.value=''; filesBox.innerHTML='';

  let model='openai/gpt-5-chat';
  if(attachments.some(a=>a.mimeType.startsWith('image/'))) model='openai/gpt-5-vision-preview';
  if(PRO && text.startsWith('/model ')) model=text.split(/\s+/)[1]||model;

  const messages=[{role:'user',content:text}];
  const payload={email,model,messages,attachments};

  try{
    const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const ct=r.headers.get('content-type')||'';
    const data=ct.includes('application/json')? await r.json() : {success:false,error:(await r.text()).slice(0,400)};
    if(!data.success){ pushAI('âŒ é€£ç·šå¤±æ•—ï¼š'+(data.error||data.upstream_body||'æœªçŸ¥éŒ¯èª¤')); return; }
    pushAI(data.reply||'(ç„¡å…§å®¹)');
    if(data.usage){ pushMeta(`${data.model} Â· tokens=${data.usage.total_tokens||0} Â· HKD$${(data.cost_hkd||0)}`); }
  }catch(err){ pushAI('âŒ é€£ç·šå¤±æ•—ï¼š'+String(err)); }
}

/* ===== UI helpers ===== */
function pushMe(t){ pushBubble('me',t); }
function pushAI(t){ pushBubble('ai',t); }
function pushMeta(t){ const el=document.createElement('div'); el.className='meta'; el.textContent=t; chat.appendChild(el); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }
function pushBubble(who,t){ const b=document.createElement('div'); b.className='bubble '+(who==='me'?'me':'ai'); b.textContent=t; chat.appendChild(b); chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'}); }

function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res((r.result||'').split(',')[1]||''); r.onerror=rej; r.readAsDataURL(file); }); }
function guessMime(name=''){
  const n=name.toLowerCase();
  if(n.endsWith('.png'))return'image/png';
  if(n.endsWith('.jpg')||n.endsWith('.jpeg'))return'image/jpeg';
  if(n.endsWith('.webp'))return'image/webp';
  if(n.endsWith('.pdf'))return'application/pdf';
  if(n.endsWith('.doc'))return'application/msword';
  if(n.endsWith('.docx'))return'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
  if(n.endsWith('.ppt'))return'application/vnd.ms-powerpoint';
  if(n.endsWith('.pptx'))return'application/vnd.openxmlformats-officedocument.presentationml.presentation';
  if(n.endsWith('.xls'))return'application/vnd.ms-excel';
  if(n.endsWith('.xlsx'))return'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
  if(n.endsWith('.txt'))return'text/plain';
  return'application/octet-stream';
}
</script>
</body>
</html>
