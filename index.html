<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gentle Â· Pay-per-Ask</title>
<style>
  :root{
    --bg:#f4f7fb; --panel:#ffffff; --bubble:#f2f6ff; --me:#e9fff3;
    --text:#102233; --muted:#5e738a; --border:#d6e0ea;
    --accent:#3ac18e; --accent2:#4aa3ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"PingFang HK","Noto Sans TC","Microsoft JhengHei",sans-serif;}
  .wrap{max-width:980px;margin:auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#fff;color:var(--text);
    border-radius:999px;padding:8px 12px;cursor:pointer;white-space:nowrap}
  .chip.active{background:linear-gradient(90deg,#49e0a6,#8ad1ff);color:#08323a;border-color:transparent}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--border);border-radius:999px;background:#fff;padding:7px 10px}
  .btn{cursor:pointer;border:1px solid var(--border);background:#fff;color:var(--text);border-radius:12px;padding:9px 12px}
  .btn.primary{background:linear-gradient(90deg,#49e0a6,#8ad1ff);border:0;color:#093039;font-weight:600}
  .btn.warn{background:#ffedee;border:1px solid #ffd6da;color:#a12233}
  input[type="email"], select{border:1px solid var(--border);background:#fff;color:var(--text);
    border-radius:12px;padding:8px 10px}
  .hint{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px}
  .chat-wrap{display:flex;flex-direction:column}
  .chat{display:flex;flex-direction:column;gap:10px;height:min(62vh,680px);
    min-height:360px;max-height:70vh;overflow:auto;padding:14px}
  .bubble{max-width:84%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);white-space:pre-wrap}
  .bot{align-self:flex-start}.bot .bubble{background:var(--bubble)}
  .me{align-self:flex-end}.me .bubble{background:var(--me)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .composer{position:sticky;bottom:0;z-index:2;border-top:1px solid var(--border);padding:10px;background:#fafcff;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  .filebox{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .filechip{border:1px dashed var(--border);background:#fff;color:var(--text);
    border-radius:10px;padding:6px 8px;font-size:12px}
  .inputs{display:flex;gap:8px;align-items:flex-end}
  textarea{flex:1;border:1px solid var(--border);background:#fff;color:var(--text);
    border-radius:12px;padding:10px 12px;min-height:64px;resize:vertical}
  #pro{display:none;border-top:1px dashed var(--border);padding:10px;background:#fafcff}
  @media (max-width:740px){ .chat{height:56vh} }
</style>
</head>
<body>
<div class="wrap">
  <!-- Top barï¼šä»»å‹™ + Email + æ§åˆ¶ -->
  <div class="card toolbar topbar">
    <div class="chips" id="taskbar">
      <button class="chip active" data-task="ask">ç™¼å•</button>
      <button class="chip" data-task="letter">å¯«ä¿¡</button>
      <button class="chip" data-task="vision">åˆ†æåœ–ç‰‡</button>
      <button class="chip" data-task="translate">ç¿»è­¯</button>
      <button class="chip" data-task="imggen">ç”Ÿæˆåœ–ç‰‡æç¤ºè©</button>
    </div>
    <div class="right">
      <label class="pill">
        <span id="lblEmail">é›»éƒµï¼ˆå¿…å¡«ï¼‰ï¼š</span>
        <input id="email" type="email" placeholder="you@example.com" style="width:220px">
      </label>
      <button id="lang" class="btn pill">ç²µèª</button>
      <button id="newchat" class="btn warn">æ¸…é™¤å°è©±</button>
      <button id="togglePro" class="btn pill">å°ˆæ¥­æ¨¡å¼ï¼šé—œ</button>
    </div>
  </div>

  <!-- Chat + Pro é¢æ¿ + ä¸‹æ–¹è¼¸å…¥åˆ— -->
  <div class="card chat-wrap">
    <div id="chat" class="chat"></div>

    <!-- å°ˆæ¥­æ¨¡å¼ï¼šæ¨¡å‹é¸æ“‡ -->
    <div id="pro">
      <div class="hint" style="margin-bottom:6px">å°ˆæ¥­æ¨¡å¼æœƒè¨˜éŒ„ç”¨é‡æ–¹ä¾¿çµç®—ï¼›äº¦å¯ä»¥è‡ªé¸æ¨¡å‹ã€‚</div>
      <label class="pill">
        <span id="lblModel">æ¨¡å‹ï¼š</span>
        <select id="model">
          <option value="openai/gpt-5-chat">openai/gpt-5-chat</option>
          <option value="anthropic/claude-3.7-sonnet">anthropic/claude-3.7-sonnet</option>
          <option value="google/gemini-2.5-flash">google/gemini-2.5-flash</option>
          <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:free</option>
          <option value="deepseek/deepseek-r1">deepseek/deepseek-r1</option>
        </select>
      </label>
    </div>

    <!-- ä¸‹æ–¹è¼¸å…¥åˆ— -->
    <div class="composer">
      <div class="filebox" id="filebox"></div>
      <div class="inputs">
        <input id="file" type="file" multiple>
        <textarea id="input" placeholder="è¼¸å…¥è¨Šæ¯â€¦ï¼ˆæ”¯æ´è²¼åœ–/ä¸Šè¼‰æª”æ¡ˆï¼‰"></textarea>
        <button id="send" class="btn primary">é€å‡º</button>
      </div>
      <div class="hint" id="footHint">æç¤ºï¼šEnter é€å‡ºï¼›Shift+Enter æ›è¡Œ</div>
    </div>
  </div>
</div>

<script>
/* ====== API URLï¼š?api= è¨­å®šä¸¦è¨˜ä½ ====== */
const DEFAULT_API = "https://script.google.com/macros/s/AKfycbzOKVyOurzY2sPadLE_OxwKZVbyKPNbbo7gfygWzLVy7O-KyCiff34yRsBXIlD4ZV4/exec";
function pickApiUrl(){
  try{
    const qs = new URLSearchParams(location.search);
    const q = qs.get('api');
    if (q){ localStorage.setItem('api_url', q); return q; }
    const s = localStorage.getItem('api_url'); return s || DEFAULT_API;
  }catch(_){ return DEFAULT_API; }
}
const EXEC_URL = pickApiUrl();

/* ====== æ–‡æ¡ˆ & ä»»å‹™ preset ====== */
const TXT = {
  'zh-HK':{
    tasks:{ ask:'ç™¼å•', letter:'å¯«ä¿¡', vision:'åˆ†æåœ–ç‰‡', translate:'ç¿»è­¯', imggen:'ç”Ÿæˆåœ–ç‰‡æç¤ºè©' },
    proOff:'å°ˆæ¥­æ¨¡å¼ï¼šé—œ', proOn:'å°ˆæ¥­æ¨¡å¼ï¼šé–‹',
    email:'é›»éƒµï¼ˆå¿…å¡«ï¼‰', model:'æ¨¡å‹',
    welcome:'ğŸ‘‹ æ­¡è¿ï¼ä¸Šé¢æ€ä»»å‹™ï¼Œä¸‹é¢è¼¸å…¥æˆ–ä¸Šè¼‰æª”æ¡ˆï¼Œæˆ‘æœƒä¸€æ­¥æ­¥å¼•å°ä½ ã€‚',
    hint:'æç¤ºï¼šEnter é€å‡ºï¼›Shift+Enter æ›è¡Œ',
    send:'é€å‡º', newchat:'æ¸…é™¤å°è©±', inputPH:'è¼¸å…¥è¨Šæ¯â€¦ï¼ˆæ”¯æ´è²¼åœ–/ä¸Šè¼‰æª”æ¡ˆï¼‰',
    guide:{
      ask:'âœ… å°è²¼å£«ï¼šè¬›æ¸…æ¥šæƒ…å¢ƒã€é™åˆ¶ã€å·²çŸ¥è³‡æ–™æˆ–ä½ æƒ³é”åˆ°å˜…æ•ˆæœã€‚',
      letter:'âœï¸ å¯«ä¿¡å¼•å°ï¼šæ”¶ä»¶äººã€ä¸»é¡Œã€ç›®çš„ã€èªæ°£ï¼ˆç¦®è²Œ/è²¼åœ°/æ­£å¼ï¼‰ã€å¤§æ¦‚å­—æ•¸ã€‚',
      vision:'ğŸ–¼ï¸ åœ–ç‰‡å¼•å°ï¼šå¯ä¸Šè¼‰å¤šå¼µï¼›å¦‚è¦ OCR è«‹è¬›æ˜ï¼›äº¦å¯è¦æ±‚ã€Œå¹«æˆ‘æ­¸ç´é‡é»ã€ã€‚',
      translate:'ğŸŒ ç¿»è­¯å¼•å°ï¼šä¾†æºâ†’ç›®æ¨™èªè¨€ï¼›å°ˆæœ‰åè©æ˜¯å¦ä¿ç•™åŸæ–‡ï¼›å£èª/æ›¸é¢ï¼Ÿ',
      imggen:'ğŸ¨ æç¤ºè©å¼•å°ï¼šä¸»é¡Œ+é¢¨æ ¼ï¼ˆå¯«å¯¦/å¡é€šï¼‰+é¡é ­ï¼ˆå»£è§’/å¾®è·ï¼‰+å…‰ç·šï¼ˆé»ƒæ˜/æŸ”å…‰ï¼‰ã€‚'
    },
    langBtn:'ç²µèª'
  },
  'en':{
    tasks:{ ask:'Ask', letter:'Write Letter', vision:'Image Analysis', translate:'Translate', imggen:'Image Prompt' },
    proOff:'Pro: Off', proOn:'Pro: On',
    email:'Email (required)', model:'Model',
    welcome:'ğŸ‘‹ Welcome! Pick a task above, then type or upload files below. Iâ€™ll guide you.',
    hint:'Tip: Enter to send; Shift+Enter for newline',
    send:'Send', newchat:'New Chat', inputPH:'Type your messageâ€¦ (paste/upload supported)',
    guide:{
      ask:'âœ… Tip: provide context, constraints, and your goal.',
      letter:'âœï¸ Letter: recipient, subject, purpose, tone (polite/friendly/formal), target length.',
      vision:'ğŸ–¼ï¸ For images: upload multiple; say if you want OCR; ask for key takeaways.',
      translate:'ğŸŒ Translation: sourceâ†’target; preserve terms? formal or casual?',
      imggen:'ğŸ¨ Prompt: subject + style (realistic/cartoon) + lens + lighting.'
    },
    langBtn:'English'
  }
};
const PRESETS = {
  'zh-HK':{
    ask:"è«‹ç”¨ç²µèªå›ç­”ä»¥ä¸‹å•é¡Œï¼Œå…ˆè¬›é‡é»ï¼Œå†ä»¥ç°¡å–®è¦é»è§£é‡‹ï¼š",
    letter:"å¹«æˆ‘ç”¨é¦™æ¸¯æ›¸é¢èªä»£å¯«ä¸€å°é›»éƒµï¼šåŒ…å«ä¸»æ—¨ã€ç¦®è²Œé–‹å ´ã€ä¸»é«”åˆ†æ®µã€æ¸…æ™°çµå°¾ã€‚",
    vision:"åˆ†ææˆ‘ä¸Šè¼‰çš„åœ–ç‰‡ï¼š1) æè¿°é‡é» 2) å¦‚æœ‰æ–‡å­—è«‹ OCR 3) æå‡ºå»ºè­°æˆ–é¢¨éšªã€‚",
    translate:"æŠŠä»¥ä¸‹å…§å®¹è­¯æˆç²µèªï¼ˆé¦™æ¸¯ç”¨å­—ï¼‰ï¼›å¦‚é™„åœ–è«‹å…ˆ OCR å†ç¿»è­¯ã€‚",
    imggen:"å¹«æˆ‘å¯«è‹±æ–‡ç”Ÿæˆåœ–ç‰‡çš„ promptï¼šä¸€å¥ä¸»æç¤ºï¼‹4â€“6 å€‹ä¿®é£¾åƒæ•¸ï¼‹ä¸€æ¢è² é¢æç¤ºã€‚"
  },
  'en':{
    ask:"Answer the following. Start with the key point, then bullet explanations:",
    letter:"Draft a polite email: subject, greeting, clear paragraphs, concise closing.",
    vision:"Analyze my uploaded image(s): 1) describe key elements 2) OCR any text 3) tips/risks.",
    translate:"Translate to English; if images attached, OCR first then translate.",
    imggen:"Write an English image prompt: one main line + 4â€“6 modifiers + one negative prompt."
  }
};
const TASK_MODEL = {
  ask:"openai/gpt-5-chat",
  letter:"openai/gpt-5-chat",
  vision:"openai/gpt-5-chat",
  translate:"openai/gpt-5-chat",
  imggen:"openai/gpt-5-chat"
};

let LANG = localStorage.getItem('lang') || 'zh-HK';
let history = [];
let pendingFiles = [];

/* ====== DOM ready ====== */
window.addEventListener('DOMContentLoaded', () => {
  let _id = 0; // â† ææ—©å®£å‘Šï¼Œé¿å… TDZ
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const fileInput = document.getElementById('file');
  const fileBox = document.getElementById('filebox');
  const sendBtn = document.getElementById('send');
  const proBtn = document.getElementById('togglePro');
  const proPanel = document.getElementById('pro');
  const modelSel = document.getElementById('model');
  const emailInput = document.getElementById('email');
  const newBtn = document.getElementById('newchat');
  const langBtn = document.getElementById('lang');
  const lblEmail = document.getElementById('lblEmail');
  const lblModel = document.getElementById('lblModel');

  function t(k){ return TXT[LANG][k]; }
  function tt(g,k){ return TXT[LANG][g][k]; }

  function initUI(){
    // ä»»å‹™ chip æ–‡æ¡ˆ
    document.querySelectorAll('.chip').forEach(ch=>{
      const task = ch.dataset.task; ch.textContent = tt('tasks', task);
    });
    // æ–‡æ¡ˆ
    document.getElementById('footHint').textContent = TXT[LANG].hint;
    sendBtn.textContent = TXT[LANG].send;
    newBtn.textContent = TXT[LANG].newchat;
    langBtn.textContent = TXT[LANG].langBtn;
    lblEmail.textContent = TXT[LANG].email + 'ï¼š';
    lblModel.textContent = TXT[LANG].model + 'ï¼š';
    input.placeholder = TXT[LANG].inputPH;

    // æ­¡è¿æ°£æ³¡
    chat.innerHTML = '';
    pushBubble('bot', TXT[LANG].welcome);

    // é‚„åŸ email
    const savedMail = localStorage.getItem('email');
    if (savedMail) emailInput.value = savedMail;
  }
  initUI();

  // èªè¨€åˆ‡æ›
  langBtn.addEventListener('click', ()=>{
    LANG = (LANG==='zh-HK'?'en':'zh-HK');
    localStorage.setItem('lang', LANG);
    initUI();
  });

  // ä»»å‹™ chipsï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
  document.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if (!chip) return;
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    const task = chip.dataset.task;
    modelSel.value = TASK_MODEL[task];               // è‡ªæ€æ¨¡å‹
    pushBubble('bot', TXT[LANG].guide[task]);        // é¡¯ç¤ºå¼•å°
    input.value = "";                                   // ç«‹å³æ¸…ç©º
    input.placeholder = PRESETS[LANG][task] || "";      // ç”¨ preset åš placeholder æç¤º
    input.focus();
  });

  // å°ˆæ¥­æ¨¡å¼
  proBtn.addEventListener('click', ()=>{
    const on = proPanel.style.display === 'block';
    proPanel.style.display = on ? 'none' : 'block';
    proBtn.textContent = on ? TXT[LANG].proOff : TXT[LANG].proOn;
  });

  // æª”æ¡ˆ
  fileInput.addEventListener('change', async ()=>{
    for (const f of fileInput.files) await addFile(f);
    fileInput.value = "";
  });
  window.addEventListener('paste', async e=>{
    if (!e.clipboardData) return;
    for (const it of e.clipboardData.items){
      if (it.kind==='file') await addFile(it.getAsFile());
    }
  });
  function guessMime(name){
    const ext=(name.split('.').pop()||'').toLowerCase();
    if(['jpg','jpeg'].includes(ext))return'image/jpeg';
    if(['png'].includes(ext))return'image/png';
    if(['gif'].includes(ext))return'image/gif';
    if(['webp'].includes(ext))return'image/webp';
    if(['pdf'].includes(ext))return'application/pdf';
    if(['doc','docx'].includes(ext))return'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
    return'application/octet-stream';
  }
  async function addFile(file){
    if(!file)return;
    const b64 = await fileToBase64(file);
    const mime = file.type || guessMime(file.name);
    pendingFiles.push({name:file.name,mime,b64});
    const chip=document.createElement('div');chip.className='filechip';
    chip.textContent=file.name+(mime.startsWith('image/')?' ğŸ–¼ï¸':'');
    fileBox.appendChild(chip);
  }
  function fileToBase64(file){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res(String(fr.result).split(",")[1]);
      fr.onerror=rej; fr.readAsDataURL(file);
    });
  }

  // é€å‡ºï¼ˆEnter / Buttonï¼‰
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });
  sendBtn.addEventListener('click', sendNow);
  newBtn.addEventListener('click', ()=>{ history=[]; chat.innerHTML=''; pushBubble('bot', TXT[LANG].welcome); });

  function getEmailRequired(){
    const mail=(emailInput.value||'').trim();
    if(!mail){ alert(LANG==='zh-HK'?'è«‹å…ˆè¼¸å…¥ Email':'Please enter your email'); emailInput.focus(); return null; }
    try{ localStorage.setItem('email', mail); }catch(_){}
    return mail;
  }

  async function sendNow(){
  const email = getEmailRequired(); if (!email) return;
  const text  = input.value.trim();

  //ï¼ˆå¦‚ç„¡å…§å®¹ä¸”å†‡é™„ä»¶ï¼Œç›´æ¥è¿”å›ï¼‰
  if (!text && pendingFiles.length === 0){
    input.placeholder = TXT[LANG].inputPH;
    return;
  }

  input.value = "";   // â† é€å‡ºå³åˆ»æ¸…ç©º
  pushBubble('me', text || '(åªæœ‰é™„ä»¶)');

    const task = (document.querySelector('.chip.active')?.dataset.task)||'ask';
    const messages=[...history,{role:"user",content:(PRESETS[LANG][task]||'')+"\n\n"+(text||'')}];
    const attachments=pendingFiles.map(p=>({filename:p.name,mimeType:p.mime,dataBase64:p.b64}));
    const payload={ email, model:(document.getElementById('model')?.value||'openai/gpt-5-chat'), messages, attachments };

    lock(true); const thinkId=pushBubble('bot','â€¦');
    try{
      const r = await fetch(EXEC_URL,{ method:"POST", body: JSON.stringify(payload) });
      const json = await r.json().catch(()=>null);
      removeBubble(thinkId);

      if(!json || json.success===false){
        pushBubble('bot', `âŒ ${json?.upstream_status||''}\n${json?.upstream_body||json?.error||'æœªçŸ¥éŒ¯èª¤'}`); return;
      }
      pushBubble('bot', json.reply || '(ç„¡å…§å®¹)');
      if(json.usage || json.cost_hkd!==undefined){
        pushMeta(`æ¨¡å‹ï¼š${json.model} Â· tokens=${json.usage?.total_tokens ?? '-'} Â· HKD$${json.cost_hkd ?? '-'}`);
      }
      history=[...messages,{role:"assistant",content:json.reply||''}];
    }catch(err){
      removeBubble(thinkId);
      console.error(err); pushBubble('bot','âŒ '+String(err));
    }finally{
      lock(false); input.value=""; pendingFiles=[]; fileBox.innerHTML="";
    }
  }

  // æ°£æ³¡å·¥å…·
  function pushBubble(who,text){
    const id='b'+(++_id);
    const item=document.createElement('div'); item.className=who; item.dataset.id=id;
    const b=document.createElement('div'); b.className='bubble'; b.textContent=text; item.appendChild(b);
    const m=document.createElement('div'); m.className='meta'; m.textContent=(who==='me'?(LANG==='zh-HK'?'ä½ ':'You'):'AI'); item.appendChild(m);
    chat.appendChild(item); chat.scrollTop=chat.scrollHeight; return id;
  }
  function removeBubble(id){ const el=document.querySelector(`[data-id="${id}"]`); if(el) el.remove(); }
  function pushMeta(text){ const m=document.createElement('div'); m.className='meta'; m.textContent=text; chat.appendChild(m); chat.scrollTop=chat.scrollHeight; }
  function lock(on){ document.getElementById('send').disabled=on; document.getElementById('input').disabled=on; document.getElementById('file').disabled=on; }
});
</script>
</body>
</html>



