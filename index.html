<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gentle · Pay-per-Ask</title>
<style>
  :root{
    --bg:#0c1118; --panel:#121925; --bubble:#0e1621; --me:#1b2a3a; --text:#e8f0ff; --muted:#9db0c8;
    --border:#1e2b3d; --accent:#65e1a3; --accent2:#8cc7ff;
  }
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a0f14,#0e1621 55%,#0c1118);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,"PingFang HK","Noto Sans TC","Microsoft JhengHei",sans-serif;}
  .wrap{max-width:880px;margin:auto;padding:14px}
  .taskbar{display:flex;gap:8px;overflow:auto;padding:6px}
  .chip{flex:0 0 auto;border:1px solid var(--border);background:#0d1520;color:#d9e6ff;border-radius:999px;
    padding:8px 12px;cursor:pointer;white-space:nowrap}
  .chip.active{background:linear-gradient(90deg,#2fe0a2,#7ae0ff);color:#06222b;border-color:transparent}
  .card{background:rgba(18,25,37,.72);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:16px}
  .chat{display:flex;flex-direction:column;gap:10px;height:62vh;min-height:360px;max-height:68vh;overflow:auto;padding:14px}
  .row{display:flex;gap:10px;align-items:flex-end;padding:10px}
  .in{display:flex;gap:8px;align-items:center;border-top:1px solid var(--border);padding:10px}
  textarea{flex:1;border:1px solid var(--border);background:#0b121b;color:var(--text);border-radius:12px;padding:10px 12px;
    min-height:56px;resize:vertical}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:#182334;color:#dbe8ff}
  .btn.primary{background:linear-gradient(90deg,#2fe0a2,#7ae0ff);color:#06222b;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .bubble{max-width:84%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);white-space:pre-wrap}
  .bot{align-self:flex-start}.bot .bubble{background:var(--bubble)}
  .me{align-self:flex-end}.me .bubble{background:var(--me)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .filebox{display:flex;gap:8px;flex-wrap:wrap}
  .filechip{border:1px dashed var(--border);background:#0c1521;color:#cfe0ff;border-radius:10px;padding:6px 8px;font-size:12px}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .pro{display:none;padding:10px;border-top:1px solid var(--border)}
  select,input[type="file"]{border:1px solid var(--border);background:#0b121b;color:var(--text);border-radius:10px;padding:8px 10px}
  .hint{font-size:12px;color:var(--muted)}
  @media (max-width:720px){ .chat{height:56vh;max-height:60vh} }
</style>
</head>
<body>
<div class="wrap">

  <!-- 任務按鈕 -->
  <div class="card" style="margin-bottom:10px">
    <div class="taskbar" id="taskbar">
      <button class="chip active" data-task="ask">發問</button>
      <button class="chip" data-task="letter">寫信</button>
      <button class="chip" data-task="vision">分析圖片</button>
      <button class="chip" data-task="translate">翻譯</button>
      <button class="chip" data-task="imggen">生成圖片提示詞</button>
    </div>
    <div class="bar">
      <div class="hint">選一個任務 → 打字或上載 → 按送出。唔使識參數，專業模式先揀模型。</div>
      <button id="togglePro" class="btn">專業模式：關</button>
    </div>
    <!-- 專業模式 -->
    <div id="pro" class="pro">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <label>你的 Email
          <input id="email" placeholder="you@example.com" style="min-width:220px">
        </label>
        <label>模型
          <select id="model">
            <option value="openai/gpt-5-chat">openai/gpt-5-chat（通用/圖像）</option>
            <option value="anthropic/claude-3.7-sonnet">anthropic/claude-3.7-sonnet（穩定）</option>
            <option value="google/gemini-2.5-flash">google/gemini-2.5-flash（快捷）</option>
            <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:free（免費）</option>
            <option value="deepseek/deepseek-r1">deepseek/deepseek-r1（推理/較貴）</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- 聊天框 -->
  <div class="card chat" id="chat">
    <!-- 歡迎訊息 -->
    <div class="bot">
      <div class="bubble">👋 歡迎！上面揀任務，喺下面輸入或上載檔案，我會幫你處理。</div>
      <div class="meta">提示：Enter 送出，Shift+Enter 換行</div>
    </div>
  </div>

  <!-- 輸入列 -->
  <div class="card in">
    <input id="file" type="file" multiple>
    <textarea id="input" placeholder="輸入訊息…（支援貼圖/上載檔案）"></textarea>
    <button id="send" class="btn primary">送出</button>
  </div>

  <!-- 檔案預覽 -->
  <div class="filebox" id="filebox" style="padding:6px 2px"></div>
</div>

<script>
const EXEC_URL = "https://script.google.com/macros/s/AKfycbzOKVyOurzY2sPadLE_OxwKZVbyKPNbbo7gfygWzLVy7O-KyCiff34yRsBXIlD4ZV4/exec";

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const fileInput = document.getElementById('file');
const fileBox = document.getElementById('filebox');
const sendBtn = document.getElementById('send');
const proBtn = document.getElementById('togglePro');
const proPanel = document.getElementById('pro');
const modelSel = document.getElementById('model');
const emailInput = document.getElementById('email');

let currentTask = 'ask';
let history = []; // {role, content} 供送去後端
let pendingFiles = []; // {file, b64, mime, name}

// 任務預設字眼（簡短，用家友善）
const PRESETS = {
  ask: "請用粵語回答以下問題，先講重點，再以簡單要點解釋：",
  letter: "幫我用香港書面語代寫一封電郵：包含主旨、禮貌開場、主體分段、清晰結尾。",
  vision: "分析我上載的圖片：1) 描述重點 2) 如有文字請 OCR 3) 給出建議或風險 4) 以粵語回覆。",
  translate: "把以下內容譯成粵語（香港用字）；如附圖請先 OCR 再翻譯。",
  imggen: "幫我寫英文生成圖片的 prompt：1) 一句主提示 2) 4–6 個修飾參數（鏡頭/光線/風格等）3) 一句負面提示。"
};

// 任務按鈕事件
document.querySelectorAll('.chip').forEach(chip=>{
  chip.onclick = ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentTask = chip.dataset.task;
    // 建議模型（僅當專業模式未開啟時提醒）
    if (currentTask === 'vision' && !proPanel.style.display) modelSel.value = 'openai/gpt-5-chat';
    if (currentTask === 'imggen' && !proPanel.style.display) modelSel.value = 'openai/gpt-5-chat';
    if (!input.value.trim()) input.value = PRESETS[currentTask];
    input.focus();
  };
});

// 專業模式切換
proBtn.onclick = ()=>{
  const on = proPanel.style.display === 'block';
  proPanel.style.display = on ? 'none' : 'block';
  proBtn.textContent = `專業模式：${on ? '關' : '開'}`;
};

// 貼圖快速上載
window.addEventListener('paste', async (e)=>{
  if (!e.clipboardData) return;
  for (const item of e.clipboardData.items) {
    if (item.kind === 'file') {
      const file = item.getAsFile();
      await addFile(file);
    }
  }
});

// 選檔
fileInput.onchange = async ()=>{
  for (const f of fileInput.files) await addFile(f);
  fileInput.value = "";
};

// 送出快捷鍵
input.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// 送出
sendBtn.onclick = async ()=>{
  const text = input.value.trim();
  const email = (emailInput?.value || "").trim();

  if (!text && pendingFiles.length===0){
    input.placeholder = "請先輸入或上載檔案";
    return;
  }
  if (proPanel.style.display === 'block' && !email){
    alert("專業模式已開，請輸入 Email 用作記錄。");
    return;
  }

  // 前端顯示：用家訊息
  pushBubble('me', text || '(只有附件)');
  if (pendingFiles.length) {
    const names = pendingFiles.map(p=>p.name).join("、");
    pushBubble('me', `📎 已上載：${names}`, true);
  }

  // 構造 messages（簡化：把任務 preset + 你輸入嘅內容合併做一個 user message）
  const base = PRESETS[currentTask] ? PRESETS[currentTask] + "\n\n" : "";
  const messages = [...history, { role:"user", content: base + (text || "") }];

  // 構造 attachments
  const attachments = pendingFiles.map(p=>({
    filename: p.name, mimeType: p.mime, dataBase64: p.b64
  }));

  // 構造 payload
  const payload = {
    email: proPanel.style.display === 'block' ? email : "",          // 專業模式先記 email
    model: modelSel.value,                                           // 可在專業模式揀模型；平時用預設值
    messages,
    attachments
  };

  lock(true);
  const typingId = pushBubble('bot', '正在思考…', true);

  try{
    const r = await fetch(EXEC_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json; charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const json = await r.json();
    // 移除「正在思考…」
    removeBubble(typingId);

    if (!json || json.success === false){
      pushBubble('bot', `❌ 失敗（上游${json?.upstream_status||''}）：\n${json?.upstream_body || json?.error || '未知錯誤'}`);
      lock(false);
      return;
    }

    // 顯示 AI 回覆 + meta
    pushBubble('bot', json.reply || '(無內容)');
    if (json.usage || json.cost_hkd !== undefined){
      pushMeta(`模型：${json.model} · tokens=${json.usage?.total_tokens ?? '-'} · HKD$${json.cost_hkd ?? '-'}`);
    }

    // 更新前端對話歷史
    history = [...messages, { role:"assistant", content: json.reply || "" }];

  }catch(err){
    removeBubble(typingId);
    pushBubble('bot', '❌ 連線失敗：' + String(err));
  }finally{
    lock(false);
    input.value = "";
    pendingFiles = [];
    fileBox.innerHTML = "";
  }
};

// 工具：加入/移除氣泡
let _id = 0;
function pushBubble(who, text, isMeta=false){
  const id = 'b'+(++_id);
  const item = document.createElement('div');
  item.className = who;
  const b = document.createElement('div');
  b.className = 'bubble';
  b.textContent = text;
  item.appendChild(b);
  if (!isMeta){
    const m = document.createElement('div');
    m.className = 'meta';
    m.textContent = who==='me'?'你':'AI';
    item.appendChild(m);
  }
  item.dataset.id = id;
  chat.appendChild(item);
  chat.scrollTop = chat.scrollHeight;
  return id;
}
function removeBubble(id){
  const el = chat.querySelector(`[data-id="${id}"]`);
  if (el) el.remove();
}
function pushMeta(text){
  const m = document.createElement('div');
  m.className = 'meta';
  m.textContent = text;
  chat.appendChild(m);
  chat.scrollTop = chat.scrollHeight;
}

// 檔案預覽
async function addFile(file){
  if (!file) return;
  const b64 = await fileToBase64(file);
  pendingFiles.push({file, b64, mime:file.type||"application/octet-stream", name:file.name});
  const chip = document.createElement('div');
  chip.className = 'filechip';
  chip.textContent = file.name + (file.type.startsWith('image/') ? ' 🖼️' : '');
  fileBox.appendChild(chip);
}
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(String(fr.result).split(",")[1]);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function lock(on){
  sendBtn.disabled = on;
  input.disabled = on;
  fileInput.disabled = on;
}
</script>
</body>
</html>
